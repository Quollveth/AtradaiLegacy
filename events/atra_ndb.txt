namespace = atra_ndb

country_event = { #destroyed
	id = atra_ndb.1000
	title = atra_ndb.1000.title
	desc = atra_ndb.1000.desc
	show_sound = event_structural_collapse
	picture = GFX_evt_large_explosion
	is_triggered_only = yes
	location = ndb_destroyed_system

	trigger = {
		fromfrom = { is_ship_size = atradai_nicoll_dyson }
	}

 #regular, destroys it normally
	option = {
		name = atra_ndb.1000.a
		custom_tooltip = atra_ndb.1000.a.tooltip
		hidden_effect = {			
			fromfrom.solar_system = {
				save_global_event_target_as = ndb_destroyed_system
				random_system_planet = {
					limit = {
						check_variable = {
							which = atra_ndb_id
							value = root.fromfrom.atra_ndb_ship_id
						}
					}
					remove_planet_flag = has_ndb
					solar_system = {
						random_system_megastructure = {
							limit = {
								check_variable = {
									which = atra_ndb_mega_id
									value = root.fromfrom.atra_ndb_ship_id
								}
							}
							solar_system = {
								spawn_megastructure = {
									type = atradai_nicoll_dyson_ruined
									planet = prev.planet
									owner = root
								}
								create_field_system_debris = yes
								create_field_system_debris = yes
								create_field_system_debris = yes
							}
							remove_megastructure = this
						}
					}
				}
			}
		}
	}
 #collapse the star
	option = {
		name = atra_ndb.1000.b
		trigger = {
			has_technology = tech_atradai_ndb_supernova
			has_country_resource = {
				type = sr_dark_matter
				amount >= 3000
			}
		}

		custom_tooltip = atra_ndb.1000.b.tooltip
		add_resource = {
			sr_dark_matter = -3000
		}
		hidden_effect = {			
			fromfrom.solar_system = {
				every_ship_in_system = { owner = { country_event = { id = atra_ndb.1010 } }	}
				save_global_event_target_as = ndb_destroyed_system
				random_system_planet = {
					limit = {
						check_variable = {
							which = atra_ndb_id
							value = root.fromfrom.atra_ndb_ship_id
						}
					}
					remove_planet_flag = has_ndb
					remove_planet_flag = has_ndb_id
					clear_variable = atra_ndb_id
					solar_system = {
						random_system_megastructure = {
							limit = {
								check_variable = {
									which = atra_ndb_mega_id
									value = root.fromfrom.atra_ndb_ship_id
								}
							}
							remove_megastructure = this
						}
						destroy_star_system = yes
						every_ship_in_system = {
							limit = {
								owner = {
									OR = { 
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
							destroy_ship = this
							#why tf are FEs immune to star eaters
						}
					}
				}
			}
		}
	}
}

country_event = {
	id = atra_ndb.1010
	title = atra_ndb.1010.title
	desc = atra_ndb.1010.desc
	show_sound = event_structural_collapse
	picture = GFX_evt_large_explosion
	is_triggered_only = yes
	location = ndb_destroyed_system
}

country_event = { #disband
	id = atra_ndb.1001
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		from = { is_ship_size = atradai_nicoll_dyson }
	}

	immediate = {
		from.solar_system = {
			random_system_planet = {
				limit = {
					check_variable = {
						which = atra_ndb_id
						value = root.from.atra_ndb_ship_id
					}
				}
				remove_planet_flag = has_ndb
				remove_planet_flag = has_ndb_id
				clear_variable = atra_ndb_id
				solar_system = {
					random_system_megastructure = {
						limit = {
							planet = { is_same_value = prevprevprev }
						}
						remove_megastructure = this
					}
				}
			}
		}
	}
}


## build stages
country_event = {
	id = atra_ndb.100
	title = atra_ndb.100.title
	desc = atra_ndb.100.desc
	picture = GFX_evt_dyson_sphere
	show_sound = event_dyson_sphere_build_start
	is_triggered_only = yes
}
country_event = {
	id = atra_ndb.101
	title = atra_ndb.101.title
	desc = atra_ndb.101.desc
	picture = GFX_evt_dyson_sphere
	show_sound = event_dyson_sphere_build_start
	is_triggered_only = yes
}
country_event = {
	id = atra_ndb.102
	title = atra_ndb.102.title
	desc = atra_ndb.102.desc
	picture = GFX_evt_dyson_sphere
	show_sound = event_dyson_sphere_build_start
	is_triggered_only = yes
}
country_event = {
	id = atra_ndb.103
	title = atra_ndb.103.title
	desc = atra_ndb.103.desc
	picture = GFX_evt_dyson_sphere
	show_sound = event_dyson_sphere_build_start
	is_triggered_only = yes
}
country_event = {
	id = atra_ndb.104
	title = atra_ndb.104.title
	desc = atra_ndb.104.desc
	picture = GFX_evt_dyson_sphere
	show_sound = event_dyson_sphere_build_start
	is_triggered_only = yes
}
